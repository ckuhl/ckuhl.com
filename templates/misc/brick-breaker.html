<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width; initial-scale = 1.0; maximum-scale=1.0; user-scalable=no"/>
    <title>Brick Breaker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/brick-breaker.css') }}">
</head>

<body>
    <canvas width="100%" height="100%" id="brick-breaker"></canvas>
<script src="{{ url_for('static', filename='js/jquery-3.1.1.js') }}" data-no-instant></script>
<script src="{{ url_for('static', filename='js/brick-breaker.js') }}" data-no-instant></script>
<script>
    // initialize canvas object
    var canvas = document.getElementById("brick-breaker");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    var context = canvas.getContext("2d");


    // Listen for user controls
    var paddlePosX = window.innerWidth / 2;
    document.addEventListener("mousemove", mouseMoveHandler, false);
    document.addEventListener("touchmove", touchMoveHandler, false);
    function mouseMoveHandler(e) {
        paddlePosX = e.clientX;
    }
    function touchMoveHandler(e) {
        paddlePosX = e.touches[0].clientX;
    }
    // top bar
    var InfoBar = {
        height: canvas.height / 16,
        width: canvas.width,
        score: 0,
        lives: 3,
        updateScore: function(brick, level) {
            this.score += (brick * level);
        },
        loseLife: function(){
            this.lives -= 1;
        },
        livesString: function(){
            var return_string = "";
            for ( var i = 0; i < this.lives; i++ ){
                return_string += "â¤";
            }
            return return_string;
        },
        draw: function(){
            context.font = "x-large Arial";
            context.fillStyle = "#000000";
            context.fillRect(0, 0, this.width, this.height);
            context.fillStyle = "#FFFFFF";
            context.fillText(this.livesString(), canvas.width / 32, canvas.height / 64 * 3);
            context.fillText(this.score.toString(), (canvas.width / 8) * 7, canvas.height / 64 * 3);
        }
    };


    // Main game field
    var PlayField = {
        x: 0,
        y: InfoBar.height,
        width: canvas.width,
        height: canvas.height - InfoBar.height
    };


    var bricks = [];
    var b_cols = 6;
    var b_rows = 3;
    for (var x = 0; x < b_cols; x++) {
        bricks[x] = [];
        for (var y = 0; y < b_rows; y++) {
            var b_width = PlayField.width / (b_cols * 2 - 1);
            var pad = b_width;
            bricks[x][y] = new Brick(PlayField.x + pad + (b_width + pad) * x,
                    PlayField.y + pad + (b_width + pad) * y,
                    b_width,
                    b_width);
        }
    }
    function draw_bricks() {
        for (var i = 0; i < b_cols; i++) {
            for (var j = 0; j < b_rows; j++) {
                b = bricks[i][j];
                if ( b.is_alive ) {
                    context.fillStyle = "#AD2323";
                    context.fillRect(b.x, b.y, b.width, b.height);
                }
            }
        }
    }
    function bricks_collision() {
        for (var i = 0; i < b_cols; i++) {
            for (var j = 0; j < b_rows; j++) {
                b = bricks[i][j];
                if (b.is_alive
                        && (Ball.x + Ball.r > b.x)
                        && (Ball.x - Ball.r < (b.x + b.width))
                        && (Ball.y + Ball.r > b.y)
                        && (Ball.y - Ball.r < (b.y + b.height))) {
                    if ((b.x + b.width / 2) - Ball.x > (b.y + b.height / 2) - Ball.y){
                        Ball.dy *= -1;
                    }else{
                        Ball.dx *= -1;
                    }
                    b.kill();
                    InfoBar.updateScore(1, 1);
                    Ball.dy *= -1;
                }
            }
        }
    }


    // ball that breaks bricks
    var Ball = {
        x: canvas.width / 2,
        y: canvas.height / 8 * 5,
        r: 10,
        dx: 2,
        dy: 2,
        draw: function (){
            context.beginPath();
            context.arc(Ball.x, Ball.y, Ball.r, 0, Math.PI*2);
            context.fillStyle = "#0095DD";
            context.fill();
            context.closePath();
        },
        update: function(){
            Ball.x += Ball.dx;
            Ball.y += Ball.dy;
        },
        reset: function(){
            Ball.x = canvas.width / 2;
            Ball.y = canvas.height / 8 * 5
        }
    };


    // player controlled paddle
    var Paddle = {
        x: paddlePosX,
        y: canvas.height - 58,
        width: 60,
        height: 8,
        dx: 3,
        dy: 0,
        draw: function() {
            context.fillStyle = "#FFF000";
            context.fillRect(this.x, this.y, this.width, this.height);
        },
        update: function() {
            this.x = paddlePosX - (this.width / 2);
        }
    };


    // the game coordinates all the other objects
    var Game = {
        draw: function(){
            context.clearRect(0, 0,
                    canvas.width,
                    canvas.height);
            Ball.draw();
            Paddle.draw();
            draw_bricks();
            InfoBar.draw();
        },

        update: function(){
            Game.collision_check();
            Ball.update();
            Paddle.update();
        },

        collision_check: function(){
            // Walls
            if ( (Ball.x - Ball.r) < 0 || (Ball.x + Ball.r) > canvas.width) {
                Ball.dx *= -1
            }
            if ( (Ball.y - Ball.r) < 0) {
                Ball.dy *= -1
            }
            if ((Ball.y + Ball.r) > canvas.height){
                InfoBar.loseLife();
                Ball.reset();
            }

            if ( (Ball.x + Ball.r > Paddle.x) && (Ball.x - Ball.r < (Paddle.x + Paddle.width))
            && (Ball.y + Ball.r > Paddle.y) && (Ball.y - Ball.r < (Paddle.y + Paddle.height))) {
                Ball.dy *= -1;
            }

            bricks_collision();
        }
    };

    setInterval(Game.draw, 10);
    setInterval(Game.update, 10);

</script>
</body>
</html>